{% extends 'base.html' %}
{% load static %}
{% block body %}
<script>
  $(document).ready( function () {
    $('#tweetTable').DataTable(
      { 
        layout: {
          topStart: 'search',
          topEnd: null,
          bottom: 'paging',
          bottomStart: null,
          bottomEnd: null
      },
        info: false,
        pagingType: 'simple_numbers',
        order: [[3, 'desc']],
        pageLength: 20,
        columnDefs: [ {
          "targets" : 'no-sort',
          "orderable": false,
          "order": [],
        },
        {targets: 1,
          render: DataTable.render.ellipsis( 40, true ),
        }]
      },
    );

    $('#kwTable').DataTable(
      { 
        layout: {
          topStart: 'info',
          bottom: 'paging',
          bottomStart: null,
          bottomEnd: null
      },
        info: false,
        pagingType: 'simple_numbers',
        order: [[1, 'desc']],
        pageLength: 20
      },
    );
    
  Chart.defaults.font.size = 14;  
  
  const ctx = document.getElementById('myChart');
  var kw_labels = []
  var kw_score = [] 
  var kw_norm_score = []

  {% for kw in keywords|slice:":20" %}
    kw_score.push({{ kw.score }})
    kw_norm_score.push(3 * {{ kw.norm_score }})
    kw_labels.push("{{ kw.word }}")
  {% endfor %}

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: kw_labels,
      datasets: [{
        label: 'Score',
        data: kw_score,
        borderWidth: 1,
        borderColor: '#34d399',
        backgroundColor: '#34d399'
      },
      {
        label: '3x Norm Score',
        data: kw_norm_score,
        borderWidth: 1,
        borderColor: '#000000',
        backgroundColor: '#000000'
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: false
        }
      },
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: true,
      borderRadius: 5
    }
  });


} );

  
</script>

<div class="relative overflow-x-auto sm:rounded-lg m-4 justify-center bg-emerald-300/20">
  <h1 class="text-center text-4xl m-4">
    Twitter Optimize Dashboard
  </h1>
  <br>
  {% if user.username %}
    <h2 class="text-center text-2xl font-semibold">
      @{{ user.username }}
    </h2>
  {% else %}
  <div class="text-center m-3">
    <button type="button" class="text-white text-xl bg-purple-700 hover:bg-purple-600 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center me-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
      <svg class="w-3.5 h-3.5 me-2" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 18 21">
      <path d="M15 12a1 1 0 0 0 .962-.726l2-7A1 1 0 0 0 17 3H3.77L3.175.745A1 1 0 0 0 2.208 0H1a1 1 0 0 0 0 2h.438l.6 2.255v.019l2 7 .746 2.986A3 3 0 1 0 9 17a2.966 2.966 0 0 0-.184-1h2.368c-.118.32-.18.659-.184 1a3 3 0 1 0 3-3H6.78l-.5-2H15Z"/>
      </svg>
        <a href="https://buy.stripe.com/test_7sI9BzbUpg1M1Rm9AB">
        Get lifetime access
        </a>
    </button>
  </div>
  {% endif %}
  <div class="text-center m-3">
    {{ stats_dates.time__min|date:"j M Y" }} - {{ stats_dates.time__max|date:"j M Y" }}
  </div>
  {% for tweet in object_list %}
  {% empty %}
  <h2 class="text-2xl font-semibold text-center">
    <a href="{% url 'upload' %}" class="btn btn-danger">   
      Upload your data to see your Twitter insights
    </a>
  </h2>
  {% endfor %}
  <br>
  <div class="grid grid-cols-1 m-5 text-center">
    <div class="grid grid-cols-1 md:grid-cols-3 m-5  text-2xl text-center">
      <div class="m-2 border rounded-lg bg-emerald-700/40">
        <p class="m-3">
        Best tweet Score
        <br>
        <span class="font-bold"> {{ stats_score.score__max|floatformat:"1" }}</span>
        </p>
      </div>
      <div class="m-2 border rounded-lg bg-emerald-700/40">
        <p class="m-3">
          Avg tweet Score
          <br>
          <span class="font-bold"> {{ stats_score.score__avg|floatformat:"1" }}</span>
          </p>
      </div>
      <div class="m-2 border rounded-lg bg-emerald-700/40">
        <p class="m-3">
          Min tweet Score
          <br>
          <span class="font-bold"> {{ stats_score.score__min|floatformat:"1" }}</span>
        </p>
      </div>
    </div>    
  </div>
  <div class="grid grid-cols-1 m-5 text-center text-2xl">
    <br>
    <br>
    <p>
      Topic Score
    </p>
    <br>
      <canvas height="300px" width="450px" id="myChart" class="m-2"></canvas>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-2 text-center">
    <div class="m-5">
      
      <p class="text-xl font-semibold m-3" id="alltweets">
        All tweets
      </p>
      <div class="mb-3 text-center items-left">
        <span class="{% if 'comments=no' in request.get_full_path %} bg-emerald-700/40 {% else %} bg-emerald-400/40 {% endif %} text-gray-800 text-sm font-medium me-2 px-1 py-1.5 rounded dark:bg-blue-900 dark:text-blue-300">
          <a href="{{ request.path }}?comments=no#alltweets" class="switch rounded-lg m-3 text-large font-bold" data-value="no">
              exclude comments
          </a>
        </span>
        <span class="{% if 'comments=yes' in request.get_full_path %} bg-emerald-700/40 {% else %} bg-emerald-400/40 {% endif %} text-gray-800 text-sm font-medium me-2 px-1 py-1.5 rounded dark:bg-blue-900 dark:text-blue-300">
          <a href="{{ request.path }}?comments=yes#alltweets" class="switch rounded-lg m-3 text-large font-bold" data-value="no">
              include comments
          </a>
        </span>
      </div>
      <table id="tweetTable" class="w-full row-border text-large text-center justify-center items-center text-gray-700 m-5">
          <thead>
              <tr class="border-b text-center items-center justify-center">                
                <th scope="row" class="px-4 py-2 font-bold text-gray-900  text-center whitespace-nowrap">
                  Date
                </th>
                <th scope="row" class="px-4 py-2 font-bold text-gray-900  text-center whitespace-nowrap">
                  Text
                </th>
                <th class="px-4 py-2 no-sort">
                  <br>
                </th>
                <th class="px-4 py-2">
                  Score
                </th>
                <th class="px-4 py-2">
                  Normalized Score
                </th>
              </tr>
          </thead>
          <tbody>
            {% for tweet in object_list %}
                <tr class="border-b items-center justify-center text-center">
                    <td scope="row" class="px-4 py-2 text-gray-600 text-sm items-center justify-center text-center">
                      {{ tweet.time }}
                    </td>
                    <td scope="row" class="px-4 py-2 font-bold text-gray-600 text-sm items-center justify-center text-center">
                      {{ tweet.text }}
                    </td>
                    <td class="px-4 py-2">
                      {% if tweet.norm_score > 70 %}
                        ðŸš€
                      {% elif tweet.norm_score > 50 %}
                        ðŸ’¥
                      {% endif %}
                    </td>
                    <td class="px-4 py-2">
                      {{ tweet.score }}
                    </td>
                    <td class="px-4 py-2">
                      {{ tweet.norm_score }}
                    </td>
                </tr>
          {% endfor %}
          </tbody>
      </table>
    </div>
    <div class="m-5">
      <p class="text-xl font-semibold m-3">
        All Topics
      </p>
      <div class="mb-2 text-left items-left">
      <br>
      </div>
      <table id="kwTable" class="w-full row-border text-large text-center justify-center items-center text-gray-700 m-3">
          <thead>
              <tr class="border-b text-center items-center justify-center">                
                <th scope="row" class="px-4 py-2 font-bold text-gray-900 items-center justify-center text-center whitespace-nowrap">
                  Keyword
                </th>
                <th class="px-4 py-2">
                  Score
                </th>
                <th class="px-4 py-2">
                  Normalized Score
                </th>
              </tr>
          </thead>
          <tbody>
            {% for kw in keywords %}
                <tr class="border-b items-center justify-center text-center">
                    <td scope="row" class="px-4 py-2 text-gray-600 font-semibold items-center justify-center text-center">
                      {{ kw.word }}
                    </td>
                    <td class="px-4 py-2">
                      {{ kw.score }}
                    </td>
                    <td class="px-4 py-2">
                      {{ kw.norm_score }}
                    </td>
                </tr>
          {% endfor %}
          </tbody>
      </table>
    </div>
  </div>    
</div>
{% endblock %}